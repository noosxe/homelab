[Unit]
Description=step-ca service
Documentation=https://smallstep.com/docs/step-ca
Documentation=https://smallstep.com/docs/step-ca/certificate-authority-server-production
Wants=network-online.target
BindsTo=dev-yubikey.device
After=dev-yubikey.device
StartLimitIntervalSec=30
StartLimitBurst=3
ConditionFileNotEmpty={{ ca_dir }}/{{ config_file }}
ConditionFileNotEmpty={{ ca_dir }}/{{ password_file }}

[Service]
Type=simple
User={{ ca_user }}
Group={{ ca_user }}
WorkingDirectory={{ ca_dir }}
ExecStart={{ podman_bin }} run --cap-add=CAP_NET_BIND_SERVICE -t --volume={{ ca_dir }}:/etc/step-ca {{ step_ca_image }}
Restart=on-failure
RestartSec=10
TimeoutStopSec=30
StartLimitInterval=30
StartLimitBurst=3

; Process capabilities & privileges
AmbientCapabilities=CAP_NET_BIND_SERVICE
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
SecureBits=keep-caps
NoNewPrivileges=yes

[Install]
WantedBy=multi-user.target
